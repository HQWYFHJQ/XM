# 校园跳蚤市场购买功能说明

## 功能概述

本次更新为校园跳蚤市场系统添加了完整的购买功能，包括微信支付、交易管理、邮件通知和系统公告定向推送等功能。

## 主要功能

### 1. 购买流程

#### 1.1 商品详情页购买
- 在商品详情页添加了"立即购买"按钮
- 点击购买后弹出微信收款码支付窗口
- 用户扫码支付后点击"我已完成支付"确认
- 系统自动创建交易记录并通知卖家

#### 1.2 交易状态管理
- **pending**: 待支付（用户点击购买后）
- **paid**: 已支付（用户确认支付后）
- **shipped**: 已发货（卖家确认发货后）
- **delivered**: 已收货（买家确认收货后）
- **completed**: 已完成（交易完成）
- **cancelled**: 已取消（交易取消）
- **timeout**: 已超时（系统自动处理）

### 2. 邮件通知系统

#### 2.1 自动邮件通知
- **购买通知**: 商品售出后自动发送邮件给卖家
- **支付确认通知**: 买家确认支付后通知卖家发货
- **发货通知**: 卖家发货后通知买家
- **收货确认通知**: 买家确认收货后通知卖家
- **超时通知**: 交易超时后通知相关用户

#### 2.2 邮件模板
- 所有邮件都使用HTML格式，包含完整的交易信息
- 邮件中包含操作链接，方便用户快速处理
- 支持邮件发送状态跟踪和错误处理

### 3. 系统公告定向推送

#### 3.1 推送类型
- **全部用户**: 推送给所有活跃用户
- **买家**: 只推送给有购买记录的用户
- **卖家**: 只推送给有销售记录的用户
- **指定用户**: 推送给指定的用户列表

#### 3.2 交易相关公告
- **发货提醒**: 商品售出后自动创建发货提醒公告
- **收货提醒**: 商品发货后自动创建收货提醒公告
- **超时通知**: 交易超时后自动创建超时通知公告

### 4. 定时任务系统

#### 4.1 交易超时处理
- 每30分钟检查一次交易状态
- 支付超时（72小时）: 自动取消交易，恢复商品状态
- 发货超时（72小时）: 自动取消交易，恢复商品状态
- 收货超时（72小时）: 自动确认收货，完成交易

#### 4.2 自动通知
- 超时交易自动发送邮件通知
- 超时交易自动创建系统公告
- 支持批量处理多个超时交易

### 5. 管理后台功能

#### 5.1 交易监控
- 实时显示交易统计信息
- 支持按状态筛选交易
- 支持搜索商品名称、买家、卖家
- 显示交易时间线和详细信息

#### 5.2 交易管理
- 查看交易详情和状态
- 手动取消交易
- 强制完成交易
- 处理超时交易

#### 5.3 数据统计
- 总交易数、各状态交易数
- 今日、本周、本月交易统计
- 交易趋势分析

## 技术实现

### 1. 数据库扩展

#### 1.1 Transaction表新增字段
```sql
-- 新增字段
payment_confirmed_at DATETIME,  -- 支付确认时间
shipped_at DATETIME,            -- 发货时间
delivered_at DATETIME,          -- 收货确认时间
timeout_at DATETIME,            -- 超时时间
shipping_notes TEXT,            -- 发货备注
delivery_notes TEXT,            -- 收货备注
dispute_reason TEXT,            -- 争议原因
admin_notes TEXT,               -- 管理员备注

-- 更新status枚举
status ENUM('pending', 'paid', 'shipped', 'delivered', 'completed', 'cancelled', 'timeout')
```

#### 1.2 Announcement表新增字段
```sql
-- 定向推送字段
target_type ENUM('all', 'buyer', 'seller', 'specific'),  -- 推送目标类型
target_user_ids TEXT,                                     -- 目标用户ID列表
target_conditions TEXT,                                   -- 推送条件
is_direct_push BOOLEAN,                                   -- 是否定向推送
push_sent BOOLEAN,                                        -- 是否已发送推送
push_sent_at DATETIME                                     -- 推送发送时间
```

### 2. API接口

#### 2.1 交易相关API
- `POST /api/transactions/purchase` - 购买商品
- `POST /api/transactions/{id}/confirm-payment` - 确认支付
- `POST /api/transactions/{id}/ship` - 发货
- `POST /api/transactions/{id}/deliver` - 确认收货
- `GET /api/transactions/{id}` - 获取交易详情
- `GET /api/transactions/my` - 获取我的交易记录

#### 2.2 管理后台API
- `GET /admin/transactions` - 交易管理页面
- `GET /admin/transactions/{id}` - 交易详情页面
- `POST /admin/transactions/{id}/cancel` - 取消交易
- `POST /admin/transactions/{id}/complete` - 强制完成交易
- `POST /admin/process-timeout-transactions` - 处理超时交易

### 3. 前端界面

#### 3.1 商品详情页
- 添加购买按钮和支付弹窗
- 微信收款码显示
- 支付确认流程
- 交易状态显示

#### 3.2 管理后台
- 交易监控面板
- 交易列表和筛选
- 交易详情页面
- 操作按钮和确认对话框

## 部署说明

### 1. 环境要求
- Python 3.8+
- MySQL 8.0+
- Redis 4.0+
- 邮件服务（SMTP）

### 2. 安装步骤

#### 2.1 更新数据库
```bash
python update_database.py
```

#### 2.2 设置定时任务
```bash
./setup_cron_transactions.sh
```

#### 2.3 运行设置脚本
```bash
./setup_purchase_system.sh
```

### 3. 配置说明

#### 3.1 邮件配置
确保 `config.py` 中的邮件配置正确：
```python
MAIL_SERVER = 'smtp.126.com'
MAIL_PORT = 25
MAIL_USE_TLS = True
MAIL_USERNAME = 'your_email@126.com'
MAIL_PASSWORD = 'your_password'
```

#### 3.2 定时任务
定时任务已自动设置，每30分钟运行一次：
```bash
*/30 * * * * cd /root/BAK && /root/miniconda3/envs/condavenv/bin/python process_transactions.py
```

## 使用说明

### 1. 用户购买流程
1. 浏览商品详情页
2. 点击"立即购买"按钮
3. 扫码支付（微信收款码）
4. 点击"我已完成支付"确认
5. 等待卖家发货
6. 确认收货完成交易

### 2. 卖家操作流程
1. 收到商品售出邮件通知
2. 登录系统查看交易详情
3. 确认发货并添加发货备注
4. 等待买家确认收货

### 3. 管理员操作
1. 登录管理后台
2. 进入"交易管理"页面
3. 查看交易统计和列表
4. 处理异常交易
5. 监控系统运行状态

## 注意事项

### 1. 安全考虑
- 微信收款码是统一的，所有商品使用同一个收款码
- 支付确认需要用户手动点击，防止误操作
- 交易超时自动处理，避免长期占用商品

### 2. 性能优化
- 邮件发送使用异步处理
- 定时任务避免重复执行
- 数据库查询优化

### 3. 错误处理
- 邮件发送失败不影响交易流程
- 定时任务异常自动重试
- 用户操作异常提供友好提示

## 联系支持

如有问题或建议，请联系系统管理员：
- 邮箱：21641685@qq.com
- 系统会自动发送相关通知邮件

---

**版本**: 1.0.0  
**更新日期**: 2024年12月  
**开发者**: 校园跳蚤市场开发团队
