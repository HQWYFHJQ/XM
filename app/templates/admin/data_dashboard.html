{% extends "base.html" %}

{% block title %}数据可视化仪表板 - 校园跳蚤市场智能推荐平台{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
<style>
.chart-container {
    position: relative;
    height: 400px;
    margin-bottom: 2rem;
}

.chart-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.stats-card h3 {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stats-card p {
    margin: 0;
    opacity: 0.9;
}

.filter-controls {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 2rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-chart-line me-2"></i>数据可视化仪表板
            </h2>
        </div>
    </div>
    
    <!-- 筛选控件 -->
    <div class="filter-controls">
        <div class="row align-items-center">
            <div class="col-md-3">
                <label class="form-label">时间范围</label>
                <select class="form-select" id="timeRange">
                    <option value="7">最近7天</option>
                    <option value="30" selected>最近30天</option>
                    <option value="90">最近90天</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">图表类型</label>
                <select class="form-select" id="chartType">
                    <option value="line">折线图</option>
                    <option value="bar">柱状图</option>
                    <option value="pie">饼图</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary mt-4" onclick="refreshCharts()">
                    <i class="fas fa-sync-alt me-2"></i>刷新数据
                </button>
            </div>
        </div>
    </div>
    
    <!-- 统计卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <h3 id="totalUsers">-</h3>
                <p>总用户数</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h3 id="totalItems">-</h3>
                <p>总商品数</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <h3 id="activeItems">-</h3>
                <p>在售商品</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <h3 id="totalViews">-</h3>
                <p>总浏览量</p>
            </div>
        </div>
    </div>
    
    <!-- 图表区域 -->
    <div class="row">
        <!-- 用户增长趋势 -->
        <div class="col-lg-6">
            <div class="chart-card">
                <h5 class="mb-3">用户增长趋势</h5>
                <div class="chart-container">
                    <canvas id="userGrowthChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 商品增长趋势 -->
        <div class="col-lg-6">
            <div class="chart-card">
                <h5 class="mb-3">商品增长趋势</h5>
                <div class="chart-container">
                    <canvas id="itemGrowthChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- 分类分布 -->
        <div class="col-lg-6">
            <div class="chart-card">
                <h5 class="mb-3">商品分类分布</h5>
                <div class="chart-container">
                    <div id="categoryChart"></div>
                </div>
            </div>
        </div>
        
        <!-- 价格分布 -->
        <div class="col-lg-6">
            <div class="chart-card">
                <h5 class="mb-3">价格分布</h5>
                <div class="chart-container">
                    <div id="priceChart"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- 用户行为统计 -->
        <div class="col-lg-6">
            <div class="chart-card">
                <h5 class="mb-3">用户行为统计</h5>
                <div class="chart-container">
                    <canvas id="behaviorChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 热门商品 -->
        <div class="col-lg-6">
            <div class="chart-card">
                <h5 class="mb-3">热门商品TOP10</h5>
                <div class="chart-container">
                    <canvas id="popularItemsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- 用户兴趣分析 -->
        <div class="col-lg-6">
            <div class="chart-card">
                <h5 class="mb-3">用户兴趣分析</h5>
                <div class="chart-container">
                    <div id="interestsChart"></div>
                </div>
            </div>
        </div>
        
        <!-- 活跃用户 -->
        <div class="col-lg-6">
            <div class="chart-card">
                <h5 class="mb-3">活跃用户TOP10</h5>
                <div class="chart-container">
                    <canvas id="activeUsersChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let charts = {};

$(document).ready(function() {
    // 初始化所有图表
    initCharts();
    
    // 加载数据
    loadOverviewStats();
    loadAllCharts();
    
    // 绑定事件
    $('#timeRange, #chartType').on('change', function() {
        loadAllCharts();
    });
});

function initCharts() {
    // 初始化Chart.js图表
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        }
    };
    
    // 用户增长图表
    charts.userGrowth = new Chart(document.getElementById('userGrowthChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '新增用户',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: chartOptions
    });
    
    // 商品增长图表
    charts.itemGrowth = new Chart(document.getElementById('itemGrowthChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '新增商品',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }]
        },
        options: chartOptions
    });
    
    // 用户行为图表
    charts.behavior = new Chart(document.getElementById('behaviorChart'), {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: chartOptions
    });
    
    // 热门商品图表
    charts.popularItems = new Chart(document.getElementById('popularItemsChart'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '浏览量',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.8)'
            }]
        },
        options: chartOptions
    });
    
    // 活跃用户图表
    charts.activeUsers = new Chart(document.getElementById('activeUsersChart'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '活跃度',
                data: [],
                backgroundColor: 'rgba(255, 159, 64, 0.8)'
            }]
        },
        options: chartOptions
    });
    
    // 初始化ECharts
    charts.category = echarts.init(document.getElementById('categoryChart'));
    charts.price = echarts.init(document.getElementById('priceChart'));
    charts.interests = echarts.init(document.getElementById('interestsChart'));
}

function loadOverviewStats() {
    $.ajax({
        url: '/api/stats/overview',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#totalUsers').text(response.data.total_users || 0);
                $('#totalItems').text(response.data.total_items || 0);
                $('#activeItems').text(response.data.active_items || 0);
                $('#totalViews').text(response.data.total_views || 0);
            }
        }
    });
}

function loadAllCharts() {
    const days = $('#timeRange').val();
    
    // 加载用户增长数据
    loadUserGrowthData(days);
    
    // 加载商品增长数据
    loadItemGrowthData(days);
    
    // 加载分类分布数据
    loadCategoryData();
    
    // 加载价格分布数据
    loadPriceData();
    
    // 加载用户行为数据
    loadBehaviorData(days);
    
    // 加载热门商品数据
    loadPopularItemsData();
    
    // 加载用户兴趣数据
    loadInterestsData();
    
    // 加载活跃用户数据
    loadActiveUsersData(days);
}

function loadUserGrowthData(days) {
    $.ajax({
        url: '/data-viz/api/user-growth',
        method: 'GET',
        data: { days: days },
        success: function(response) {
            if (response.success) {
                const labels = response.data.map(item => item.date);
                const data = response.data.map(item => item.count);
                
                charts.userGrowth.data.labels = labels;
                charts.userGrowth.data.datasets[0].data = data;
                charts.userGrowth.update();
            }
        }
    });
}

function loadItemGrowthData(days) {
    $.ajax({
        url: '/data-viz/api/item-growth',
        method: 'GET',
        data: { days: days },
        success: function(response) {
            if (response.success) {
                const labels = response.data.map(item => item.date);
                const data = response.data.map(item => item.count);
                
                charts.itemGrowth.data.labels = labels;
                charts.itemGrowth.data.datasets[0].data = data;
                charts.itemGrowth.update();
            }
        }
    });
}

function loadCategoryData() {
    $.ajax({
        url: '/data-viz/api/category-distribution',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const option = {
                    tooltip: {
                        trigger: 'item'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left'
                    },
                    series: [{
                        name: '商品分类',
                        type: 'pie',
                        radius: '50%',
                        data: response.data,
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                charts.category.setOption(option);
            }
        }
    });
}

function loadPriceData() {
    $.ajax({
        url: '/data-viz/api/price-distribution',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const option = {
                    tooltip: {
                        trigger: 'item'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left'
                    },
                    series: [{
                        name: '价格分布',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        data: response.data,
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                charts.price.setOption(option);
            }
        }
    });
}

function loadBehaviorData(days) {
    $.ajax({
        url: '/data-viz/api/behavior-stats',
        method: 'GET',
        data: { days: days },
        success: function(response) {
            if (response.success) {
                const labels = response.data.map(item => item.name);
                const data = response.data.map(item => item.value);
                
                charts.behavior.data.labels = labels;
                charts.behavior.data.datasets[0].data = data;
                charts.behavior.update();
            }
        }
    });
}

function loadPopularItemsData() {
    $.ajax({
        url: '/data-viz/api/popular-items',
        method: 'GET',
        data: { limit: 10 },
        success: function(response) {
            if (response.success) {
                const labels = response.data.map(item => item.name.length > 10 ? item.name.substring(0, 10) + '...' : item.name);
                const data = response.data.map(item => item.value);
                
                charts.popularItems.data.labels = labels;
                charts.popularItems.data.datasets[0].data = data;
                charts.popularItems.update();
            }
        }
    });
}

function loadInterestsData() {
    $.ajax({
        url: '/data-viz/api/user-interests',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const option = {
                    tooltip: {
                        trigger: 'item'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left'
                    },
                    series: [{
                        name: '用户兴趣',
                        type: 'pie',
                        radius: '50%',
                        data: response.data,
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                charts.interests.setOption(option);
            }
        }
    });
}

function loadActiveUsersData(days) {
    $.ajax({
        url: '/data-viz/api/active-users',
        method: 'GET',
        data: { days: days },
        success: function(response) {
            if (response.success) {
                const labels = response.data.map(item => item.name);
                const data = response.data.map(item => item.value);
                
                charts.activeUsers.data.labels = labels;
                charts.activeUsers.data.datasets[0].data = data;
                charts.activeUsers.update();
            }
        }
    });
}

function refreshCharts() {
    loadOverviewStats();
    loadAllCharts();
}

// 响应式处理
window.addEventListener('resize', function() {
    Object.values(charts).forEach(chart => {
        if (chart.resize) {
            chart.resize();
        }
    });
});
</script>
{% endblock %}
