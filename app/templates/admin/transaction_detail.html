{% extends "admin/base.html" %}

{% block title %}交易详情 - 管理后台{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-exchange-alt me-2"></i>交易详情 #{{ transaction.id }}
        </h1>
        <div>
            <a href="{{ url_for('admin.transactions') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>返回列表
            </a>
        </div>
    </div>

    <div class="row">
        <!-- 交易基本信息 -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">交易信息</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold">交易ID:</td>
                                    <td>#{{ transaction.id }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">价格:</td>
                                    <td class="text-success fw-bold">¥{{ "%.2f"|format(transaction.price) }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">状态:</td>
                                    <td>
                                        {% set status_config = {
                                            'pending': {'class': 'warning', 'text': '待支付'},
                                            'paid': {'class': 'info', 'text': '已支付'},
                                            'shipped': {'class': 'secondary', 'text': '已发货'},
                                            'completed': {'class': 'success', 'text': '已完成'},
                                            'cancelled': {'class': 'danger', 'text': '已取消'}
                                        } %}
                                        {% set config = status_config.get(transaction.status, {'class': 'secondary', 'text': transaction.status}) %}
                                        <span class="badge bg-{{ config.class }} fs-6">{{ config.text }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">创建时间:</td>
                                    <td>{{ transaction.created_at.strftime('%Y-%m-%d %H:%M:%S') if transaction.created_at else '-' }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">更新时间:</td>
                                    <td>{{ transaction.updated_at.strftime('%Y-%m-%d %H:%M:%S') if transaction.updated_at else '-' }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold">买家:</td>
                                    <td>
                                        {% if buyer %}
                                            <div>
                                                <div class="fw-bold">{{ buyer.username }}</div>
                                                <small class="text-muted">ID: {{ buyer.id }}</small>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">用户已删除</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">卖家:</td>
                                    <td>
                                        {% if seller %}
                                            <div>
                                                <div class="fw-bold">{{ seller.username }}</div>
                                                <small class="text-muted">ID: {{ seller.id }}</small>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">用户已删除</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">商品ID:</td>
                                    <td>{{ transaction.item_id }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 商品信息 -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">商品信息</h6>
                </div>
                <div class="card-body">
                    {% if item %}
                    <div class="row">
                        <div class="col-md-4">
                            {% if item.images %}
                                <img src="{{ url_for('static', filename='uploads/items/' + item.images[0]) }}" 
                                     class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                     style="height: 200px;">
                                    <i class="fas fa-image fa-3x text-muted"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <h5 class="fw-bold">{{ item.title }}</h5>
                            <p class="text-muted">{{ item.description[:200] }}{% if item.description|length > 200 %}...{% endif %}</p>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">分类: {{ item.category.name if item.category else '未分类' }}</small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">状态: 
                                        {% if item.status == 'active' %}
                                            <span class="text-success">在售</span>
                                        {% elif item.status == 'sold' %}
                                            <span class="text-warning">已售出</span>
                                        {% else %}
                                            <span class="text-muted">{{ item.status }}</span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                            <div class="mt-2">
                                <a href="{{ url_for('main.item_detail', item_id=item.id) }}" 
                                   class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="fas fa-external-link-alt me-1"></i>查看商品详情
                                </a>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-muted">商品已删除</h5>
                        <p class="text-muted">此交易关联的商品已被删除</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 交易备注 -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">交易备注</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold text-info">买家备注</h6>
                            {% if transaction.buyer_notes %}
                                <div class="bg-light p-3 rounded">
                                    {{ transaction.buyer_notes }}
                                </div>
                            {% else %}
                                <p class="text-muted">无买家备注</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold text-success">卖家备注</h6>
                            {% if transaction.seller_notes %}
                                <div class="bg-light p-3 rounded">
                                    {{ transaction.seller_notes }}
                                </div>
                            {% else %}
                                <p class="text-muted">无卖家备注</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 管理员操作记录 -->
            {% if transaction.admin_notes %}
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">管理员操作记录</h6>
                </div>
                <div class="card-body">
                    {% for note in transaction.admin_notes %}
                    <div class="border-start border-3 border-primary ps-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold">{{ note.admin_name }}</div>
                                <small class="text-muted">{{ note.timestamp }}</small>
                            </div>
                            {% if note.action %}
                                <span class="badge bg-warning">{{ note.action }}</span>
                            {% endif %}
                        </div>
                        {% if note.note %}
                            <div class="mt-2">{{ note.note }}</div>
                        {% endif %}
                        {% if note.reason %}
                            <div class="mt-2">
                                <strong>原因:</strong> {{ note.reason }}
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- 操作面板 -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">管理员操作</h6>
                </div>
                <div class="card-body">
                    {% if transaction.status in ['pending', 'paid', 'shipped'] %}
                    <div class="d-grid mb-3">
                        <button class="btn btn-warning" onclick="showStatusModal({{ transaction.id }}, '{{ transaction.status }}')">
                            <i class="fas fa-edit me-2"></i>更新状态
                        </button>
                    </div>
                    {% endif %}

                    {% if transaction.status in ['paid', 'shipped'] %}
                    <div class="d-grid mb-3">
                        <button class="btn btn-danger" onclick="showRefundModal({{ transaction.id }})">
                            <i class="fas fa-undo me-2"></i>处理退款
                        </button>
                    </div>
                    {% endif %}

                    <div class="d-grid mb-3">
                        <a href="{{ url_for('admin.export_transactions') }}" class="btn btn-success">
                            <i class="fas fa-download me-2"></i>导出数据
                        </a>
                    </div>

                    <hr>

                    <div class="alert alert-info">
                        <h6 class="alert-heading">操作说明</h6>
                        <ul class="mb-0 small">
                            <li><strong>更新状态:</strong> 手动调整交易状态</li>
                            <li><strong>处理退款:</strong> 将交易状态设为已取消</li>
                            <li><strong>导出数据:</strong> 下载所有交易数据</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 交易时间线 -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">交易时间线</h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">交易创建</h6>
                                <small class="text-muted">{{ transaction.created_at.strftime('%Y-%m-%d %H:%M:%S') if transaction.created_at else '-' }}</small>
                            </div>
                        </div>

                        {% if transaction.status in ['paid', 'shipped', 'completed'] %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">买家支付</h6>
                                <small class="text-muted">买家确认支付</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if transaction.status in ['shipped', 'completed'] %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-secondary"></div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">卖家发货</h6>
                                <small class="text-muted">卖家确认发货</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if transaction.status == 'completed' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">交易完成</h6>
                                <small class="text-muted">买家确认收货</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if transaction.status == 'cancelled' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-danger"></div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">交易取消</h6>
                                <small class="text-muted">交易已取消</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 状态更新模态框 -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">更新交易状态</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <input type="hidden" id="transactionId" name="transaction_id">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">新状态</label>
                        <select class="form-select" id="newStatus" name="status" required>
                            <option value="">请选择状态</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="adminNote" class="form-label">管理员备注</label>
                        <textarea class="form-control" id="adminNote" name="admin_note" rows="3" 
                                  placeholder="请输入状态更新原因或备注信息"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateTransactionStatus()">确认更新</button>
            </div>
        </div>
    </div>
</div>

<!-- 退款模态框 -->
<div class="modal fade" id="refundModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">处理退款</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="refundForm">
                    <input type="hidden" id="refundTransactionId" name="transaction_id">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        确认要处理此交易的退款吗？此操作不可撤销。
                    </div>
                    <div class="mb-3">
                        <label for="refundReason" class="form-label">退款原因</label>
                        <textarea class="form-control" id="refundReason" name="reason" rows="3" 
                                  placeholder="请输入退款原因" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="processRefund()">确认退款</button>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 0 0 3px #e3e6f0;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -29px;
    top: 17px;
    width: 2px;
    height: calc(100% + 10px);
    background: #e3e6f0;
}

.timeline-content h6 {
    margin-bottom: 5px;
    color: #5a5c69;
}
</style>

<script>
// 状态转换映射
const statusTransitions = {
    'pending': [
        {value: 'paid', text: '已支付'},
        {value: 'cancelled', text: '已取消'}
    ],
    'paid': [
        {value: 'shipped', text: '已发货'},
        {value: 'cancelled', text: '已取消'}
    ],
    'shipped': [
        {value: 'completed', text: '已完成'},
        {value: 'cancelled', text: '已取消'}
    ]
};

function showStatusModal(transactionId, currentStatus) {
    document.getElementById('transactionId').value = transactionId;
    
    const statusSelect = document.getElementById('newStatus');
    statusSelect.innerHTML = '<option value="">请选择状态</option>';
    
    const transitions = statusTransitions[currentStatus] || [];
    transitions.forEach(transition => {
        const option = document.createElement('option');
        option.value = transition.value;
        option.textContent = transition.text;
        statusSelect.appendChild(option);
    });
    
    new bootstrap.Modal(document.getElementById('statusModal')).show();
}

function showRefundModal(transactionId) {
    document.getElementById('refundTransactionId').value = transactionId;
    new bootstrap.Modal(document.getElementById('refundModal')).show();
}

function updateTransactionStatus() {
    const transactionId = document.getElementById('transactionId').value;
    const status = document.getElementById('newStatus').value;
    const adminNote = document.getElementById('adminNote').value;
    
    if (!status) {
        alert('请选择新状态');
        return;
    }
    
    fetch(`/admin/transactions/${transactionId}/update_status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: status,
            admin_note: adminNote
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('状态更新成功');
            location.reload();
        } else {
            alert('更新失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('更新失败，请重试');
    });
}

function processRefund() {
    const transactionId = document.getElementById('refundTransactionId').value;
    const reason = document.getElementById('refundReason').value;
    
    if (!reason.trim()) {
        alert('请输入退款原因');
        return;
    }
    
    fetch(`/admin/transactions/${transactionId}/refund`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('退款处理成功');
            location.reload();
        } else {
            alert('退款处理失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('退款处理失败，请重试');
    });
}
</script>
{% endblock %}