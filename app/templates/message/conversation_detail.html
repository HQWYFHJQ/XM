{% extends "base.html" %}

{% block title %}对话详情 - 校园跳蚤市场{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-lg-5 my-4">
    <div class="row">
        <!-- 对话信息侧边栏 -->
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <a href="{{ url_for('message.messages') }}" class="btn btn-sm btn-outline-secondary me-2">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <h6 class="mb-0">对话信息</h6>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 对方用户信息 -->
                    <div class="text-center mb-3">
                        {% if conversation_data.other_participant and conversation_data.other_participant.avatar %}
                        <img src="{{ url_for('static', filename='uploads/avatars/' + conversation_data.other_participant.avatar) }}" 
                             class="rounded-circle mb-2" width="80" height="80" alt="头像">
                        {% else %}
                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto mb-2" 
                             style="width: 80px; height: 80px;">
                            <i class="fas fa-user fa-2x text-muted"></i>
                        </div>
                        {% endif %}
                        <h6 class="mb-1">{{ conversation_data.other_participant.username if conversation_data.other_participant else '未知用户' }}</h6>
                        <small class="text-muted">
                            {% if conversation_data.conversation.conversation_type == 'item_chat' %}
                            商品咨询
                            {% else %}
                            一般聊天
                            {% endif %}
                        </small>
                    </div>
                    
                    <!-- 商品信息 -->
                    {% if conversation_data.item %}
                    <div class="border-top pt-3 mb-3">
                        <h6 class="text-muted mb-2">相关商品</h6>
                        <div class="card">
                            <div class="card-body p-2">
                                <div class="d-flex">
                                    {% if conversation_data.item.get_main_image() %}
                                    <img src="{{ url_for('static', filename='uploads/items/' + conversation_data.item.get_main_image()) }}" 
                                         class="rounded me-2" width="50" height="50" style="object-fit: cover;" alt="商品图片">
                                    {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center me-2" 
                                         style="width: 50px; height: 50px;">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>
                                    {% endif %}
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 small">{{ conversation_data.item.title }}</h6>
                                        <div class="text-primary fw-bold small">¥{{ conversation_data.item.price }}</div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <a href="{{ url_for('main.item_detail', item_id=conversation_data.item.id) }}" 
                                       class="btn btn-sm btn-outline-primary w-100">查看商品</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- 操作按钮 -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="searchInConversation()">
                            <i class="fas fa-search me-1"></i>搜索消息
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteConversation()">
                            <i class="fas fa-trash me-1"></i>删除对话
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 聊天区域 -->
        <div class="col-md-9">
            <div class="card h-100 d-flex flex-column">
                <!-- 聊天头部 -->
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            {{ conversation_data.other_participant.username if conversation_data.other_participant else '未知用户' }}
                            {% if conversation_data.conversation.conversation_type == 'item_chat' %}
                            <small class="text-muted">(商品咨询)</small>
                            {% endif %}
                        </h6>
                        <small class="text-muted">
                            {% if conversation_data.other_participant %}
                            {% if conversation_data.other_participant.is_online %}
                            <span class="text-success">
                                <i class="fas fa-circle me-1"></i>在线
                            </span>
                            {% else %}
                            <span class="text-muted">
                                <i class="fas fa-circle me-1"></i>离线
                            </span>
                            {% endif %}
                            {% endif %}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadMoreMessages()">
                            <i class="fas fa-history me-1"></i>加载更多
                        </button>
                    </div>
                </div>
                
                <!-- 消息列表 -->
                <div class="card-body flex-grow-1 p-0">
                    <div id="messagesContainer" class="messages-container">
                        {% if messages.items %}
                        <div id="messagesList" class="messages-list">
                            {% for message in messages.items %}
                            <div class="message-item {% if message.sender_id == current_user.id %}message-sent{% else %}message-received{% endif %}">
                                <div class="message-content">
                                    <div class="message-text">{{ message.content }}</div>
                                    <div class="message-time">
                                        {{ message.created_at | beijing_datetime }}
                                        {% if message.sender_id == current_user.id and message.is_read %}
                                        <i class="fas fa-check-double text-primary ms-1" title="已读"></i>
                                        {% elif message.sender_id == current_user.id %}
                                        <i class="fas fa-check text-muted ms-1" title="已发送"></i>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">开始对话</h5>
                            <p class="text-muted">发送第一条消息开始聊天吧！</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 消息输入区域 -->
                <div class="card-footer">
                    <form id="messageForm" class="d-flex">
                        <div class="flex-grow-1 me-2">
                            <input type="text" class="form-control" id="messageInput" 
                                   placeholder="输入消息..." maxlength="1000" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 搜索消息模态框 -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">搜索消息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="searchInput" class="form-label">搜索关键词</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="输入要搜索的内容...">
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.messages-container {
    height: 500px;
    overflow-y: auto;
    padding: 1rem;
    background-color: #f8f9fa;
}

.messages-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.message-item {
    display: flex;
    margin-bottom: 1rem;
}

.message-sent {
    justify-content: flex-end;
}

.message-received {
    justify-content: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    position: relative;
}

.message-sent .message-content {
    background-color: #007bff;
    color: white;
    border-bottom-right-radius: 0.25rem;
}

.message-received .message-content {
    background-color: white;
    color: #333;
    border: 1px solid #dee2e6;
    border-bottom-left-radius: 0.25rem;
}

.message-text {
    margin-bottom: 0.25rem;
    word-wrap: break-word;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
}

.search-results {
    max-height: 300px;
    overflow-y: auto;
}

.search-result-item {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.search-result-item:hover {
    background-color: #f8f9fa;
}

.search-result-item.highlight {
    background-color: #fff3cd;
    border-color: #ffc107;
}

/* 滚动条样式 */
.messages-container::-webkit-scrollbar {
    width: 6px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.messages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .messages-container {
        height: 400px;
    }
    
    .message-content {
        max-width: 85%;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 从模板中获取数据
const conversationId = {{ conversation_data.conversation.id }};
const currentUserId = {{ current_user.id if current_user.is_authenticated else 'null' }};
let currentPage = 1;
let isLoading = false;

// 发送消息功能已移至 sendMessage() 函数

// 添加消息到界面
function addMessageToUI(message) {
    const isSent = message.sender_id === currentUserId;
    const messageClass = isSent ? 'message-sent' : 'message-received';
    
    const messageHtml = `
        <div class="message-item ${messageClass}">
            <div class="message-content">
                <div class="message-text">${message.content}</div>
                <div class="message-time">
                    ${formatTime(message.created_at)}
                    ${isSent ? '<i class="fas fa-check text-muted ms-1" title="已发送"></i>' : ''}
                </div>
            </div>
        </div>
    `;
    
    $('#messagesList').append(messageHtml);
}

// 格式化时间
function formatTime(timeString) {
    const date = new Date(timeString);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) { // 1分钟内
        return '刚刚';
    } else if (diff < 3600000) { // 1小时内
        const minutes = Math.floor(diff / 60000);
        return `${minutes}分钟前`;
    } else if (diff < 86400000) { // 1天内
        const hours = Math.floor(diff / 3600000);
        return `${hours}小时前`;
    } else {
        return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
    }
}

// 滚动到底部
function scrollToBottom() {
    const container = $('#messagesContainer');
    container.scrollTop(container[0].scrollHeight);
}

// 加载更多消息
function loadMoreMessages() {
    if (isLoading) return;
    
    isLoading = true;
    currentPage++;
    
    $.ajax({
        url: `/api/messages/${conversationId}/messages`,
        method: 'GET',
        data: { page: currentPage },
        success: function(response) {
            if (response.success && response.messages.length > 0) {
                // 确保消息列表存在
                let messagesList = $('#messagesList');
                if (messagesList.length === 0) {
                    $('#messagesContainer').html('<div id="messagesList" class="messages-list"></div>');
                    messagesList = $('#messagesList');
                }
                
                // 在顶部插入新消息
                const messagesHtml = response.messages.map(message => {
                    const isSent = message.sender_id === currentUserId;
                    const messageClass = isSent ? 'message-sent' : 'message-received';
                    
                    return `
                        <div class="message-item ${messageClass}">
                            <div class="message-content">
                                <div class="message-text">${message.content}</div>
                                <div class="message-time">
                                    ${formatTime(message.created_at)}
                                    ${isSent ? '<i class="fas fa-check text-muted ms-1" title="已发送"></i>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                messagesList.prepend(messagesHtml);
            }
        },
        complete: function() {
            isLoading = false;
        }
    });
}

// 搜索对话中的消息
function searchInConversation() {
    $('#searchModal').modal('show');
}

$('#searchInput').on('input', function() {
    const query = $(this).val().trim();
    if (query.length < 2) {
        $('#searchResults').empty();
        return;
    }
    
    $.ajax({
        url: '/api/messages/search',
        method: 'GET',
        data: { q: query },
        success: function(response) {
            if (response.success) {
                displaySearchResults(response.messages);
            }
        }
    });
});

// 显示搜索结果
function displaySearchResults(messages) {
    const container = $('#searchResults');
    container.empty();
    
    if (messages.length === 0) {
        container.html('<div class="text-muted">未找到相关消息</div>');
        return;
    }
    
    messages.forEach(message => {
        const messageHtml = `
            <div class="search-result-item" onclick="scrollToMessage(${message.id})">
                <div class="fw-bold">${message.sender_name}</div>
                <div class="text-muted small">${message.content}</div>
                <div class="text-muted small">${formatTime(message.created_at)}</div>
            </div>
        `;
        container.append(messageHtml);
    });
}

// 滚动到指定消息
function scrollToMessage(messageId) {
    // 这里可以实现滚动到特定消息的功能
    $('#searchModal').modal('hide');
}

// 删除对话
function deleteConversation() {
    if (!confirm('确定要删除这个对话吗？删除后无法恢复。')) {
        return;
    }
    
    $.ajax({
        url: `/api/messages/${conversationId}/delete`,
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showAlert('对话已删除', 'success');
                setTimeout(() => {
                    window.location.href = '/messages';
                }, 1000);
            } else {
                showAlert(response.error, 'error');
            }
        },
        error: function() {
            showAlert('删除失败，请重试', 'error');
        }
    });
}

// 发送消息
let isSending = false; // 防重复发送标志

function sendMessage() {
    // 防止重复发送
    if (isSending) {
        console.log('正在发送中，忽略重复请求');
        return;
    }
    
    const messageInput = $('#messageInput');
    const content = messageInput.val().trim();
    
    console.log('发送消息:', { conversationId, currentUserId, content });
    
    if (!content) {
        showAlert('请输入消息内容', 'warning');
        return;
    }
    
    // 设置发送状态
    isSending = true;
    
    const sendButton = $('#sendButton');
    const originalHtml = sendButton.html();
    
    // 显示发送状态
    sendButton.html('<div class="spinner-border spinner-border-sm" role="status"></div>');
    sendButton.prop('disabled', true);
    
    $.ajax({
        url: '/api/messages/send',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            conversation_id: conversationId,
            content: content,
            message_type: 'text'
        }),
        success: function(response) {
            if (response.success) {
                messageInput.val('');
                
                // 确保消息列表存在
                let messagesList = $('#messagesList');
                if (messagesList.length === 0) {
                    // 如果消息列表不存在，创建它并替换空状态
                    $('#messagesContainer').html('<div id="messagesList" class="messages-list"></div>');
                    messagesList = $('#messagesList');
                }
                
                // 添加新消息到界面
                const messageHtml = `
                    <div class="message-item message-sent">
                        <div class="message-content">
                            <div class="message-text">${content}</div>
                            <div class="message-time">
                                ${formatTime(new Date().toISOString())}
                                <i class="fas fa-check text-muted ms-1" title="已发送"></i>
                            </div>
                        </div>
                    </div>
                `;
                
                messagesList.append(messageHtml);
                scrollToBottom();
                showAlert('消息发送成功', 'success');
            } else {
                showAlert(response.error || '发送失败', 'error');
            }
        },
        error: function(xhr) {
            let errorMessage = '发送失败，请重试';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            }
            showAlert(errorMessage, 'error');
        },
        complete: function() {
            // 重置发送状态
            isSending = false;
            sendButton.html(originalHtml);
            sendButton.prop('disabled', false);
        }
    });
}

// 页面加载完成后滚动到底部
$(document).ready(function() {
    scrollToBottom();
    
    // 自动聚焦到输入框
    $('#messageInput').focus();
    
    // 绑定消息发送事件
    $('#messageForm').on('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // 定期检查新消息（每5秒）
    setInterval(function() {
        checkNewMessages();
    }, 5000);
});

// 检查新消息
function checkNewMessages() {
    $.ajax({
        url: `/api/messages/${conversationId}/messages`,
        method: 'GET',
        data: { page: 1 },
        success: function(response) {
            if (response.success) {
                // 这里可以实现新消息的实时更新
                // 由于是简化版本，暂时不实现
            }
        }
    });
}
</script>
{% endblock %}
