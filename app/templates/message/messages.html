{% extends "base.html" %}

{% block title %}我的消息 - 校园跳蚤市场{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-lg-5 my-4">
    <div class="row">
        <!-- 侧边栏 -->
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>我的消息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2 mb-3">
                        <button class="btn btn-primary" onclick="startNewChat()">
                            <i class="fas fa-plus me-2"></i>开始新对话
                        </button>
                    </div>
                    
                    <!-- 搜索框 -->
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="messageSearch" placeholder="搜索消息...">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchMessages()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 筛选选项 -->
                    <div class="mb-3">
                        <h6 class="text-muted">筛选</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="filterType" id="filterAll" value="all" checked>
                            <label class="form-check-label" for="filterAll">
                                全部对话
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="filterType" id="filterUnread" value="unread">
                            <label class="form-check-label" for="filterUnread">
                                未读消息
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="filterType" id="filterItemChat" value="item_chat">
                            <label class="form-check-label" for="filterItemChat">
                                商品咨询
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 对话列表 -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h5 class="mb-0 me-3">对话列表</h5>
                        <span class="badge bg-primary" id="unreadCount">0</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="form-check me-3" id="selectAllContainer" style="display: none;">
                            <input class="form-check-input" type="checkbox" id="selectAll">
                            <label class="form-check-label" for="selectAll">全选</label>
                        </div>
                        <button class="btn btn-outline-danger btn-sm me-2" id="deleteSelectedBtn" style="display: none;" onclick="deleteSelectedConversations()">
                            <i class="fas fa-trash me-1"></i>删除选中
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectionMode()">
                            <i class="fas fa-check-square me-1"></i>选择模式
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if conversation_list %}
                    <div class="list-group list-group-flush" id="conversationList">
                        {% set grouped_conversations = {} %}
                        {% for conv_data in conversation_list %}
                            {% set user_id = conv_data.other_participant.id if conv_data.other_participant else 'unknown' %}
                            {% set user_name = conv_data.other_participant.username if conv_data.other_participant else '未知用户' %}
                            {% if user_id not in grouped_conversations %}
                                {% set _ = grouped_conversations.update({user_id: {'user_name': user_name, 'conversations': []}}) %}
                            {% endif %}
                            {% set _ = grouped_conversations[user_id]['conversations'].append(conv_data) %}
                        {% endfor %}
                        
                        {% for user_id, user_data in grouped_conversations.items() %}
                        <div class="conversation-group">
                            <div class="conversation-group-header">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" class="form-check-input me-2 user-checkbox" data-user-id="{{ user_id }}" onchange="toggleUserSelection('{{ user_id }}')">
                                    <h6 class="mb-0">{{ user_data.user_name }}</h6>
                                    <span class="badge bg-secondary ms-2">{{ user_data.conversations|length }} 个对话</span>
                                </div>
                            </div>
                            
                            {% for conv_data in user_data.conversations %}
                            <div class="conversation-item-wrapper">
                                <div class="conversation-item {% if conv_data.unread_count > 0 %}unread{% endif %}" 
                                     data-conversation-id="{{ conv_data.conversation.id }}">
                                    <div class="d-flex align-items-center">
                                        <!-- 选择框 -->
                                        <div class="conversation-checkbox me-3" style="display: none;">
                                            <input type="checkbox" class="form-check-input conversation-checkbox" 
                                                   data-conversation-id="{{ conv_data.conversation.id }}" 
                                                   data-user-id="{{ user_id }}"
                                                   onchange="updateSelectionState()">
                                        </div>
                                        
                                        <!-- 对话链接 -->
                                        <a href="{{ url_for('message.conversation_detail', conversation_id=conv_data.conversation.id) }}" 
                                           class="conversation-link flex-grow-1 text-decoration-none">
                                            <div class="d-flex w-100 justify-content-between align-items-start">
                                                <div class="d-flex">
                                                    <!-- 头像 -->
                                                    <div class="me-3">
                                                        {% if conv_data.other_participant and conv_data.other_participant.avatar %}
                                                        <img src="{{ url_for('static', filename='uploads/avatars/' + conv_data.other_participant.avatar) }}" 
                                                             class="rounded-circle" width="50" height="50" alt="头像">
                                                        {% else %}
                                                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" 
                                                             style="width: 50px; height: 50px;">
                                                            <i class="fas fa-user text-muted"></i>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <!-- 对话信息 -->
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                                            <h6 class="mb-0">
                                                                {% if conv_data.conversation.conversation_type == 'item_chat' %}
                                                                <small class="text-muted">(商品咨询)</small>
                                                                {% endif %}
                                                            </h6>
                                                            <small class="text-muted">
                                                                {{ conv_data.conversation.last_message_at | beijing_datetime }}
                                                            </small>
                                                        </div>
                                                        
                                                        <!-- 商品信息 -->
                                                        {% if conv_data.item %}
                                                        <div class="mb-1">
                                                            <small class="text-primary">
                                                                <i class="fas fa-tag me-1"></i>{{ conv_data.item.title }}
                                                            </small>
                                                        </div>
                                                        {% endif %}
                                                        
                                                        <!-- 最后一条消息 -->
                                                        {% if conv_data.last_message %}
                                                        <p class="mb-0 text-muted small">
                                                            {% if conv_data.last_message.sender_id == current_user.id %}
                                                            <span class="text-primary">我: </span>
                                                            {% endif %}
                                                            {{ conv_data.last_message.content[:50] }}{% if conv_data.last_message.content|length > 50 %}...{% endif %}
                                                        </p>
                                                        {% else %}
                                                        <p class="mb-0 text-muted small">暂无消息</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                
                                                <!-- 未读消息数量 -->
                                                {% if conv_data.unread_count > 0 %}
                                                <span class="badge bg-danger rounded-pill">{{ conv_data.unread_count }}</span>
                                                {% endif %}
                                            </div>
                                        </a>
                                        
                                        <!-- 删除按钮 -->
                                        <div class="conversation-actions ms-2" style="display: none;">
                                            <button class="btn btn-outline-danger btn-sm delete-conversation-btn" 
                                                    data-conversation-id="{{ conv_data.conversation.id }}"
                                                    title="删除对话">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">暂无对话</h5>
                        <p class="text-muted">开始与卖家聊天吧！</p>
                        <button class="btn btn-primary" onclick="startNewChat()">
                            <i class="fas fa-plus me-2"></i>开始新对话
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                <!-- 分页 -->
                {% if conversations.pages > 1 %}
                <div class="card-footer">
                    <nav aria-label="对话分页">
                        <ul class="pagination justify-content-center mb-0">
                            {% if conversations.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('message.messages', page=conversations.prev_num) }}">上一页</a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in conversations.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != conversations.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('message.messages', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if conversations.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('message.messages', page=conversations.next_num) }}">下一页</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 开始新对话模态框 -->
<div class="modal fade" id="startChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">开始新对话</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="searchUser" class="form-label">搜索用户</label>
                    <input type="text" class="form-control" id="searchUser" placeholder="输入用户名...">
                    <div id="userSearchResults" class="mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmStartChat()">开始对话</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.conversation-group {
    border-bottom: 1px solid #dee2e6;
}

.conversation-group:last-child {
    border-bottom: none;
}

.conversation-group-header {
    background-color: #f8f9fa;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #dee2e6;
    font-weight: 600;
}

.conversation-item-wrapper {
    border-bottom: 1px solid #f1f3f4;
}

.conversation-item-wrapper:last-child {
    border-bottom: none;
}

.conversation-item {
    padding: 1rem;
    transition: background-color 0.2s ease;
    border: none;
}

.conversation-item:hover {
    background-color: #f8f9fa;
}

.conversation-item.unread {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.conversation-item.unread:hover {
    background-color: #bbdefb;
}

.conversation-link {
    color: inherit;
}

.conversation-link:hover {
    color: inherit;
}

.conversation-checkbox {
    margin: 0;
}

.user-checkbox {
    margin: 0;
}

.conversation-actions {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.conversation-item:hover .conversation-actions {
    opacity: 1;
}

.selection-mode .conversation-checkbox,
.selection-mode .user-checkbox {
    display: block !important;
}

.selection-mode .conversation-actions {
    display: block !important;
}

.selection-mode .conversation-link {
    pointer-events: none;
}

.user-search-result {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.user-search-result:hover {
    background-color: #f8f9fa;
}

.user-search-result.selected {
    background-color: #e3f2fd;
    border-color: #2196f3;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let selectedUserId = null;
let isSelectionMode = false;

// 开始新对话
function startNewChat() {
    $('#startChatModal').modal('show');
}

// 搜索用户
$('#searchUser').on('input', function() {
    const query = $(this).val().trim();
    if (query.length < 2) {
        $('#userSearchResults').empty();
        return;
    }
    
    // 这里应该调用搜索用户的API
    // 暂时使用模拟数据
    setTimeout(() => {
        const mockUsers = [
            { id: 1, username: '用户1', avatar: null },
            { id: 2, username: '用户2', avatar: null }
        ].filter(user => user.username.includes(query));
        
        displayUserSearchResults(mockUsers);
    }, 300);
});

// 显示用户搜索结果
function displayUserSearchResults(users) {
    const container = $('#userSearchResults');
    container.empty();
    
    if (users.length === 0) {
        container.html('<div class="text-muted">未找到用户</div>');
        return;
    }
    
    users.forEach(user => {
        const userHtml = `
            <div class="user-search-result" data-user-id="${user.id}">
                <div class="d-flex align-items-center">
                    <div class="me-2">
                        ${user.avatar ? 
                            `<img src="/static/uploads/avatars/${user.avatar}" class="rounded-circle" width="30" height="30" alt="头像">` :
                            `<div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;"><i class="fas fa-user text-muted"></i></div>`
                        }
                    </div>
                    <div>
                        <div class="fw-bold">${user.username}</div>
                    </div>
                </div>
            </div>
        `;
        container.append(userHtml);
    });
    
    // 绑定点击事件
    $('.user-search-result').on('click', function() {
        $('.user-search-result').removeClass('selected');
        $(this).addClass('selected');
        selectedUserId = $(this).data('user-id');
    });
}

// 确认开始对话
function confirmStartChat() {
    if (!selectedUserId) {
        showAlert('请选择一个用户', 'error');
        return;
    }
    
    // 调用API开始对话
    $.ajax({
        url: '/api/messages/start-chat',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            user_id: selectedUserId
        }),
        success: function(response) {
            if (response.success) {
                window.location.href = `/messages/${response.conversation_id}`;
            } else {
                showAlert(response.error, 'error');
            }
        },
        error: function() {
            showAlert('操作失败，请重试', 'error');
        }
    });
}

// 搜索消息
function searchMessages() {
    const query = $('#messageSearch').val().trim();
    if (!query) {
        showAlert('请输入搜索关键词', 'error');
        return;
    }
    
    window.location.href = `/messages/search?q=${encodeURIComponent(query)}`;
}

// 更新未读消息数量
function updateUnreadCount() {
    $.ajax({
        url: '/api/messages/unread-count',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#unreadCount').text(response.unread_count);
                if (response.unread_count > 0) {
                    $('#unreadCount').removeClass('bg-primary').addClass('bg-danger');
                } else {
                    $('#unreadCount').removeClass('bg-danger').addClass('bg-primary');
                }
            }
        }
    });
}

// 切换选择模式
function toggleSelectionMode() {
    isSelectionMode = !isSelectionMode;
    const conversationList = document.getElementById('conversationList');
    const selectAllContainer = document.getElementById('selectAllContainer');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    
    if (isSelectionMode) {
        conversationList.classList.add('selection-mode');
        selectAllContainer.style.display = 'block';
        deleteSelectedBtn.style.display = 'block';
    } else {
        conversationList.classList.remove('selection-mode');
        selectAllContainer.style.display = 'none';
        deleteSelectedBtn.style.display = 'none';
        // 清除所有选择
        document.querySelectorAll('.conversation-checkbox, .user-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAll').checked = false;
    }
}

// 切换用户选择
function toggleUserSelection(userId) {
    const userCheckbox = document.querySelector(`[data-user-id="${userId}"]`);
    const conversationCheckboxes = document.querySelectorAll(`[data-user-id="${userId}"].conversation-checkbox`);
    
    conversationCheckboxes.forEach(cb => {
        cb.checked = userCheckbox.checked;
    });
    
    updateSelectionState();
}

// 更新选择状态
function updateSelectionState() {
    const allCheckboxes = document.querySelectorAll('.conversation-checkbox');
    const checkedCheckboxes = document.querySelectorAll('.conversation-checkbox:checked');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    // 更新全选状态
    selectAllCheckbox.checked = allCheckboxes.length > 0 && checkedCheckboxes.length === allCheckboxes.length;
    selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
    
    // 更新用户选择框状态
    const userGroups = {};
    allCheckboxes.forEach(cb => {
        const userId = cb.dataset.userId;
        if (!userGroups[userId]) {
            userGroups[userId] = { total: 0, checked: 0 };
        }
        userGroups[userId].total++;
        if (cb.checked) {
            userGroups[userId].checked++;
        }
    });
    
    Object.keys(userGroups).forEach(userId => {
        const userCheckbox = document.querySelector(`[data-user-id="${userId}"].user-checkbox`);
        const group = userGroups[userId];
        userCheckbox.checked = group.checked === group.total;
        userCheckbox.indeterminate = group.checked > 0 && group.checked < group.total;
    });
}

// 全选/取消全选
document.getElementById('selectAll').addEventListener('change', function() {
    const allCheckboxes = document.querySelectorAll('.conversation-checkbox');
    allCheckboxes.forEach(cb => {
        cb.checked = this.checked;
    });
    updateSelectionState();
});

// 删除选中的对话
function deleteSelectedConversations() {
    const checkedCheckboxes = document.querySelectorAll('.conversation-checkbox:checked');
    if (checkedCheckboxes.length === 0) {
        showAlert('请选择要删除的对话', 'warning');
        return;
    }
    
    if (!confirm(`确定要删除选中的 ${checkedCheckboxes.length} 个对话吗？删除后无法恢复。`)) {
        return;
    }
    
    const conversationIds = Array.from(checkedCheckboxes).map(cb => parseInt(cb.dataset.conversationId));
    
    $.ajax({
        url: '/api/messages/batch-delete',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            conversation_ids: conversationIds
        }),
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                // 刷新页面
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(response.error, 'error');
            }
        },
        error: function() {
            showAlert('删除失败，请重试', 'error');
        }
    });
}

// 删除单个对话
function deleteSingleConversation(conversationId) {
    if (!confirm('确定要删除这个对话吗？删除后无法恢复。')) {
        return;
    }
    
    $.ajax({
        url: `/api/messages/${conversationId}/delete`,
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showAlert('对话已删除', 'success');
                // 刷新页面
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(response.error, 'error');
            }
        },
        error: function() {
            showAlert('删除失败，请重试', 'error');
        }
    });
}

// 页面加载时更新未读数量
$(document).ready(function() {
    updateUnreadCount();
    
    // 每30秒更新一次未读数量
    setInterval(updateUnreadCount, 30000);
    
    // 绑定删除按钮点击事件
    $(document).on('click', '.delete-conversation-btn', function() {
        const conversationId = $(this).data('conversation-id');
        deleteSingleConversation(conversationId);
    });
});
</script>
{% endblock %}
