<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}æ ¡å›­è·³èš¤å¸‚åœº{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/logo.ico') }}" type="image/x-icon">
    <link rel="icon" href="{{ url_for('static', filename='images/logo.ico') }}" type="image/x-icon">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    <!-- AIæ¨èæ¨¡æ€æ¡†CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ai_recommend.css') }}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- è·³è¿‡é“¾æ¥ - å…è®¸ç”¨æˆ·å¿«é€Ÿè·³è½¬åˆ°ä¸»è¦å†…å®¹ï¼ˆä»…æ— éšœç¢æ¨¡å¼å¼€å¯æ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="skip-links" id="skip-links" style="display: none;">
        <a href="#main-content" class="skip-link">è·³è½¬åˆ°ä¸»è¦å†…å®¹</a>
        <a href="#navigation" class="skip-link">è·³è½¬åˆ°å¯¼èˆªèœå•</a>
        <a href="#search" class="skip-link">è·³è½¬åˆ°æœç´¢æ¡†</a>
    </div>
    
    <!-- å±å¹•é˜…è¯»å™¨å®æ—¶æ’­æŠ¥åŒºåŸŸ -->
    <div id="sr-live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    
    <!-- å±å¹•é˜…è¯»å™¨çŠ¶æ€æ’­æŠ¥åŒºåŸŸ -->
    <div id="sr-status-region" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm" role="navigation" aria-label="ä¸»å¯¼èˆª" id="navigation">
        <div class="container-fluid px-3 px-lg-5">
            <!-- å“ç‰Œ -->
            <a class="navbar-brand fw-bold text-primary" href="{{ url_for('main.index') }}" aria-label="æ ¡å›­è·³èš¤å¸‚åœº - è¿”å›é¦–é¡µ">
                <i class="fas fa-store me-2" aria-hidden="true"></i>æ ¡å›­è·³èš¤å¸‚åœº
            </a>
            
            <!-- ç§»åŠ¨ç«¯åˆ‡æ¢æŒ‰é’® -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆªèœå•">
                <span class="navbar-toggler-icon" aria-hidden="true"></span>
            </button>
            
            <!-- å¯¼èˆªèœå• -->
            <div class="collapse navbar-collapse" id="navbarNav" role="menubar">
                <!-- å·¦ä¾§å¯¼èˆªèœå• -->
                <ul class="navbar-nav me-auto" role="menubar">
                    <li class="nav-item" role="none">
                        <a class="nav-link" href="{{ url_for('main.index') }}" role="menuitem" aria-label="è®¿é—®é¦–é¡µ">
                            <i class="fas fa-home me-1" aria-hidden="true"></i>é¦–é¡µ
                        </a>
                    </li>
                    <li class="nav-item" role="none">
                        <a class="nav-link" href="{{ url_for('main.items') }}" role="menuitem" aria-label="æµè§ˆæ‰€æœ‰å•†å“">
                            <i class="fas fa-th-large me-1" aria-hidden="true"></i>å•†å“
                        </a>
                    </li>
                    <li class="nav-item" role="none">
                        <a class="nav-link" href="{{ url_for('main.create_item') }}" role="menuitem" aria-label="å‘å¸ƒæ–°å•†å“">
                            <i class="fas fa-plus me-1" aria-hidden="true"></i>å‘å¸ƒ
                        </a>
                    </li>
                    <li class="nav-item" role="none">
                        <a class="nav-link" href="{{ url_for('main.announcements') }}" role="menuitem" aria-label="æŸ¥çœ‹ç³»ç»Ÿå…¬å‘Š">
                            <i class="fas fa-bullhorn me-1" aria-hidden="true"></i>å…¬å‘Š
                        </a>
                    </li>
                    {% if current_user.is_authenticated %}
                    <li class="nav-item" role="none">
                        <a class="nav-link" href="{{ url_for('main.recommendations') }}" role="menuitem" aria-label="æŸ¥çœ‹ä¸ªæ€§åŒ–æ¨èå•†å“">
                            <i class="fas fa-magic me-1" aria-hidden="true"></i>ä¸ªæ€§åŒ–æ¨è
                        </a>
                    </li>
                    {% endif %}
                    {% if current_user.is_authenticated %}
                    <li class="nav-item" role="none">
                            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aiRecommendModal" role="menuitem" aria-label="æ‰“å¼€æ™ºèƒ½æ¨èåŠ©æ‰‹">
                            <i class="fas fa-robot me-1" aria-hidden="true"></i>æ™ºèƒ½æ¨è
                        </a>
                    </li>
                    {% else %}
                    <li class="nav-item" role="none">
                            <a class="nav-link" href="{{ url_for('main.login') }}" role="menuitem" aria-label="ç™»å½•åä½¿ç”¨æ™ºèƒ½æ¨è">
                            <i class="fas fa-robot me-1" aria-hidden="true"></i>æ™ºèƒ½æ¨è
                        </a>
                    </li>
                    {% endif %}
                </ul>
                
                <!-- æœç´¢æ¡† -->
                <form class="d-flex me-3" method="GET" action="{{ url_for('main.items') }}" role="search" aria-label="å•†å“æœç´¢">
                    <label for="search-input" class="visually-hidden">æœç´¢å•†å“</label>
                    <input class="form-control me-2" type="search" name="search" id="search-input" 
                           placeholder="æœç´¢å•†å“..." value="{{ request.args.get('search', '') }}"
                           aria-describedby="search-help">
                    <button class="btn btn-outline-primary" type="submit" aria-label="æ‰§è¡Œæœç´¢">
                        <i class="fas fa-search" aria-hidden="true"></i>
                    </button>
                    <div id="search-help" class="visually-hidden">è¾“å…¥å•†å“åç§°æˆ–å…³é”®è¯è¿›è¡Œæœç´¢</div>
                </form>
                
                <!-- æ§åˆ¶å¼€å…³åŒºåŸŸ -->
                <div class="d-flex align-items-center me-3" role="group" aria-label="ç½‘ç«™è®¾ç½®">
                    <!-- å¤œé—´/ç™½å¤©æ¨¡å¼åˆ‡æ¢ -->
                    <div class="btn-group me-2" role="group" aria-label="ä¸»é¢˜æ¨¡å¼åˆ‡æ¢">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="theme-toggle" 
                                aria-label="åˆ‡æ¢ä¸»é¢˜æ¨¡å¼" title="åˆ‡æ¢å¤œé—´/ç™½å¤©æ¨¡å¼">
                            <i class="fas fa-sun" id="theme-icon" aria-hidden="true"></i>
                            <span class="visually-hidden" id="theme-text">åˆ‡æ¢åˆ°å¤œé—´æ¨¡å¼</span>
                        </button>
                    </div>
                    
                    <!-- æ— éšœç¢åŠŸèƒ½å¼€å…³ -->
                    <div class="btn-group" role="group" aria-label="æ— éšœç¢åŠŸèƒ½æ§åˆ¶">
                        <button type="button" class="btn btn-sm btn-outline-info" id="accessibility-toggle" 
                                aria-label="åˆ‡æ¢æ— éšœç¢åŠŸèƒ½" title="å¼€å¯/å…³é—­æ— éšœç¢åŠŸèƒ½">
                            <i class="fas fa-universal-access" id="accessibility-icon" aria-hidden="true"></i>
                            <span class="visually-hidden" id="accessibility-text">å¼€å¯æ— éšœç¢åŠŸèƒ½</span>
                        </button>
                    </div>
                </div>
                
                <!-- å³ä¾§ç”¨æˆ·èœå• -->
                <ul class="navbar-nav" role="menubar">
                    {% if current_user.is_authenticated %}
                        <li class="nav-item dropdown" role="none">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" 
                               data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" 
                               aria-label="ç”¨æˆ·èœå• - {{ current_user.username }}">
                                {% if current_user.avatar %}
                                    <img src="{{ url_for('static', filename='uploads/avatars/' + current_user.avatar) }}" 
                                         class="rounded-circle me-1" width="24" height="24" alt="{{ current_user.username }}çš„å¤´åƒ">
                                {% else %}
                                    <i class="fas fa-user-circle me-1" aria-hidden="true"></i>
                                {% endif %}
                                <span class="visually-hidden">ç”¨æˆ·ï¼š</span>{{ current_user.username }}
                            </a>
                            <ul class="dropdown-menu" role="menu" aria-labelledby="navbarDropdown">
                                <li role="none"><a class="dropdown-item" href="{{ url_for('main.profile') }}" role="menuitem">
                                    <i class="fas fa-user me-2" aria-hidden="true"></i>ä¸ªäººä¸­å¿ƒ
                                </a></li>
                                <li role="none"><a class="dropdown-item" href="{{ url_for('main.my_items') }}" role="menuitem">
                                    <i class="fas fa-box me-2" aria-hidden="true"></i>æˆ‘çš„å•†å“
                                </a></li>
                                <li role="none"><a class="dropdown-item" href="{{ url_for('message.messages') }}" role="menuitem">
                                    <i class="fas fa-comments me-2" aria-hidden="true"></i>æˆ‘çš„æ¶ˆæ¯
                                </a></li>
                                {% if current_user.is_admin %}
                                <li role="none"><hr class="dropdown-divider"></li>
                                <li role="none"><a class="dropdown-item" href="{{ url_for('admin.dashboard') }}" role="menuitem">
                                    <i class="fas fa-cog me-2" aria-hidden="true"></i>ç®¡ç†åå°
                                </a></li>
                                {% endif %}
                                <li role="none"><hr class="dropdown-divider"></li>
                                <li role="none"><a class="dropdown-item" href="{{ url_for('main.logout') }}" role="menuitem">
                                    <i class="fas fa-sign-out-alt me-2" aria-hidden="true"></i>é€€å‡ºç™»å½•
                                </a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item" role="none">
                            <a class="nav-link" href="{{ url_for('main.login') }}" role="menuitem" aria-label="ç”¨æˆ·ç™»å½•">
                                <i class="fas fa-sign-in-alt me-1" aria-hidden="true"></i>ç™»å½•
                            </a>
                        </li>
                        <li class="nav-item" role="none">
                            <a class="nav-link" href="{{ url_for('main.register') }}" role="menuitem" aria-label="ç”¨æˆ·æ³¨å†Œ">
                                <i class="fas fa-user-plus me-1" aria-hidden="true"></i>æ³¨å†Œ
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- ç³»ç»Ÿå…¬å‘Š -->
    {% if announcements and current_user.is_authenticated %}
        <div class="container mt-3" role="alert" aria-live="polite" aria-atomic="true">
            {% for announcement in announcements %}
                <div class="alert alert-{{ 'danger' if announcement.priority == 'urgent' else 'warning' if announcement.priority == 'high' else 'info' if announcement.type == 'notice' else 'primary' }} alert-dismissible fade show announcement-item" 
                     role="alert" aria-live="assertive" data-announcement-id="{{ announcement.id }}">
                    <div class="d-flex align-items-start">
                        <i class="{{ announcement.get_type_icon() }} me-2 mt-1" aria-hidden="true"></i>
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <h6 class="mb-0 me-2">{{ announcement.title }}</h6>
                                {% if announcement.is_pinned %}
                                    <i class="fas fa-thumbtack text-warning" title="ç½®é¡¶å…¬å‘Š" aria-label="ç½®é¡¶å…¬å‘Š"></i>
                                {% endif %}
                                <span class="badge bg-{{ 'danger' if announcement.priority == 'urgent' else 'warning' if announcement.priority == 'high' else 'primary' }} ms-2">
                                    {{ 'ç´§æ€¥' if announcement.priority == 'urgent' else 'é«˜' if announcement.priority == 'high' else 'æ™®é€š' if announcement.priority == 'normal' else 'ä½' }}
                                </span>
                            </div>
                            <div class="announcement-content">{{ announcement.render_content() | safe }}</div>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1" aria-hidden="true"></i>
                                {{ announcement.created_at | beijing_datetime }}
                            </small>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="å…³é—­æ­¤å…¬å‘Š" onclick="markAnnouncementAsRead({{ announcement.id }})"></button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- æ¶ˆæ¯æç¤º -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3" role="alert" aria-live="polite" aria-atomic="true">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" 
                         role="alert" aria-live="assertive">
                        <span class="visually-hidden">æ¶ˆæ¯ç±»å‹ï¼š</span>
                        <strong>{{ 'é”™è¯¯' if category == 'error' else ('æˆåŠŸ' if category == 'success' else ('è­¦å‘Š' if category == 'warning' else 'ä¿¡æ¯')) }}</strong>
                        <span class="visually-hidden">æ¶ˆæ¯å†…å®¹ï¼š</span>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="å…³é—­æ­¤æ¶ˆæ¯"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- ä¸»è¦å†…å®¹ -->
    <main id="main-content" role="main" aria-label="ä¸»è¦å†…å®¹">
        {% block content %}{% endblock %}
    </main>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
    <button id="backToTop" title="å›åˆ°é¡¶éƒ¨" aria-label="å›åˆ°é¡µé¢é¡¶éƒ¨" class="back-to-top-btn">
        <i class="fas fa-chevron-up" aria-hidden="true"></i>
        <span class="visually-hidden">å›åˆ°é¡¶éƒ¨</span>
    </button>

    <!-- é¡µè„š -->
    <footer class="bg-dark text-light py-5" role="contentinfo" aria-label="ç½‘ç«™é¡µè„š">
        <div class="container-fluid px-3 px-lg-5">
            <div class="row">
                <!-- å¹³å°ä»‹ç» -->
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar-circle me-3" aria-hidden="true">
                            <i class="fas fa-store fa-2x"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">æ ¡å›­è·³èš¤å¸‚åœº</h5>
                            <small class="text-muted">æ™ºèƒ½æ¨èå¹³å°</small>
                        </div>
                    </div>
                    <p class="text-muted mb-3">
                        æ™ºèƒ½æ¨èï¼Œç²¾å‡†åŒ¹é…ï¼Œè®©é—²ç½®ç‰©å“é‡æ–°å‘å…‰å‘çƒ­ã€‚ä¸ºæ ¡å›­ç”Ÿæ´»æä¾›ä¾¿æ·çš„äºŒæ‰‹äº¤æ˜“å¹³å°ã€‚
                    </p>
                    <div class="social-links" role="list" aria-label="ç¤¾äº¤åª’ä½“é“¾æ¥">
                        <a href="#" class="text-light me-3" role="listitem" aria-label="è®¿é—®å®˜æ–¹ç½‘ç«™"><i class="fas fa-globe fa-lg" aria-hidden="true"></i></a>
                        <a href="#" class="text-light me-3" role="listitem" aria-label="è®¢é˜…é€šçŸ¥"><i class="fas fa-bell fa-lg" aria-hidden="true"></i></a>
                        <a href="#" class="text-light me-3" role="listitem" aria-label="è´­ç‰©è½¦"><i class="fas fa-shopping-cart fa-lg" aria-hidden="true"></i></a>
                        <a href="#" class="text-light" role="listitem" aria-label="åˆ·æ–°é¡µé¢"><i class="fas fa-sync-alt fa-lg" aria-hidden="true"></i></a>
                    </div>
                </div>

                <!-- å¿«é€Ÿé“¾æ¥ -->
                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3">å¿«é€Ÿé“¾æ¥</h6>
                    <ul class="list-unstyled" role="list" aria-label="å¿«é€Ÿå¯¼èˆªé“¾æ¥">
                        <li class="mb-2" role="listitem">
                            <a href="{{ url_for('main.index') }}" class="text-muted text-decoration-none" aria-label="è®¿é—®é¦–é¡µ">
                                <i class="fas fa-home me-2" aria-hidden="true"></i>é¦–é¡µ
                            </a>
                        </li>
                        <li class="mb-2" role="listitem">
                            <a href="{{ url_for('main.items') }}" class="text-muted text-decoration-none" aria-label="æµè§ˆå•†å“åˆ†ç±»">
                                <i class="fas fa-th-large me-2" aria-hidden="true"></i>å•†å“åˆ†ç±»
                            </a>
                        </li>
                        <li class="mb-2" role="listitem">
                            <a href="{{ url_for('main.items') }}" class="text-muted text-decoration-none" aria-label="æœç´¢å•†å“">
                                <i class="fas fa-search me-2" aria-hidden="true"></i>æœç´¢
                            </a>
                        </li>
                        <li class="mb-2" role="listitem">
                            <a href="#" class="text-muted text-decoration-none" aria-label="äº†è§£æˆ‘ä»¬">
                                <i class="fas fa-info-circle me-2" aria-hidden="true"></i>å…³äºæˆ‘ä»¬
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- å•†å“åˆ†ç±» -->
                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3">å•†å“åˆ†ç±»</h6>
                    <ul class="list-unstyled" role="list" aria-label="å•†å“åˆ†ç±»å¯¼èˆª">
                        {% for category in parent_categories %}
                        <li class="mb-2" role="listitem">
                            <a href="{{ url_for('main.items', parent_category=category.id) }}" class="text-muted text-decoration-none" 
                               aria-label="æµè§ˆ{{ category.name }}åˆ†ç±»å•†å“">
                                <i class="{{ category.icon or 'fas fa-tag' }} me-2" aria-hidden="true"></i>{{ category.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- è”ç³»æˆ‘ä»¬ -->
                <div class="col-lg-4 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3">è”ç³»æˆ‘ä»¬</h6>
                    <div class="contact-info" role="list" aria-label="è”ç³»æ–¹å¼">
                        <div class="d-flex align-items-center mb-3" role="listitem">
                            <i class="fas fa-envelope me-3 text-primary" aria-hidden="true"></i>
                            <span class="text-muted">
                                <span class="visually-hidden">é‚®ç®±ï¼š</span>21641685@qq.com
                            </span>
                        </div>
                        <div class="d-flex align-items-center mb-3" role="listitem">
                            <i class="fas fa-phone me-3 text-primary" aria-hidden="true"></i>
                            <span class="text-muted">
                                <span class="visually-hidden">ç”µè¯ï¼š</span>182-0000-7541
                            </span>
                        </div>
                        <div class="d-flex align-items-center mb-3" role="listitem">
                            <i class="fas fa-map-marker-alt me-3 text-primary" aria-hidden="true"></i>
                            <span class="text-muted">
                                <span class="visually-hidden">åœ°å€ï¼š</span>ä¸­å›½Â·è´µå·Â·å®‰é¡ºå¸‚
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç‰ˆæƒä¿¡æ¯ -->
            <hr class="my-4" aria-hidden="true">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-0 text-muted">
                        <span class="visually-hidden">ç‰ˆæƒä¿¡æ¯ï¼š</span>Â© 2025 æ ¡å›­è·³èš¤å¸‚åœºï¼Œä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0 text-muted">
                        <i class="fas fa-heart text-danger" aria-hidden="true"></i> 
                        <span class="visually-hidden">ç†å¿µï¼š</span>è®©èµ„æºå¾ªç¯åˆ©ç”¨ï¼Œå…±å»ºç»¿è‰²æ ¡å›­
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- æ— éšœç¢æ”¯æŒJS -->
    <script src="{{ url_for('static', filename='js/accessibility.js') }}"></script>
    
    <!-- ä¸»é¢˜æ§åˆ¶JS -->
    <script src="{{ url_for('static', filename='js/theme-controls.js') }}"></script>
    
    <!-- AIæ¨èæ¨¡æ€æ¡†JS -->
    <script src="{{ url_for('static', filename='js/ai_recommend.js') }}"></script>

    <!-- AIæ¨èæ¨¡æ€æ¡† -->
    {% if current_user.is_authenticated %}
    <div class="modal fade" id="aiRecommendModal" tabindex="-1" aria-labelledby="aiRecommendModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content ai-chat-modal">
                <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
                <div class="modal-header ai-chat-header">
                    <div class="ai-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ai-header-info">
                        <h5 class="modal-title" id="aiRecommendModalLabel">æ™ºèƒ½æ¨è</h5>
                        <p class="ai-status">åœ¨çº¿ Â· éšæ—¶ä¸ºæ‚¨æœåŠ¡</p>
                    </div>
                    <div class="ai-status-dot"></div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                </div>
                
                <!-- æ¨¡æ€æ¡†å†…å®¹ -->
                <div class="modal-body ai-chat-body">
                    <div class="ai-chat-container" id="ai-chat-container">
                        <!-- æ¬¢è¿æ¶ˆæ¯ -->
                        <div class="ai-welcome-message">
                            <h6>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½æ¨èåŠ©æ‰‹</h6>
                            <p>æˆ‘å¯ä»¥æ ¹æ®æ‚¨çš„å–œå¥½ä¸ºæ‚¨æ¨èåˆé€‚çš„å•†å“ï¼Œæˆ–è€…å›ç­”æ‚¨å…³äºå•†å“çš„é—®é¢˜</p>
                        </div>
                        
                        <!-- AIåˆå§‹æ¶ˆæ¯ -->
                        <div class="ai-message ai-message-ai">
                            <div class="ai-bubble ai-bubble-ai">
                                åŸºäºGeminiæ¨¡å‹æ¨èï¼Œç¼–è¾‘éœ€æ±‚å¦‚ï¼š"æˆ‘æƒ³è¦ä¸€ä¸ªå›ºæ€ç¡¬ç›˜ï¼Œä»·æ ¼åœ¨200å…ƒåˆ°1000å…ƒä¹‹é—´ï¼Œæœ€å¥½æ˜¯å…¨æ–°çš„ã€‚"å³å¯è¿›è¡Œæ™ºèƒ½æ¨èã€‚
                                <div class="ai-message-time">åˆšåˆš</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="modal-footer ai-input-area">
                    <div class="ai-input-group">
                        <input type="text" class="ai-input-field" id="ai-user-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–éœ€æ±‚..." autocomplete="off">
                        <button class="ai-send-button" id="ai-send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ç”¨æˆ·IDå…¨å±€å˜é‡ -->
    <script>
        window.currentUserId = {{ current_user.id if current_user.is_authenticated else 'null' }};
    </script>
    
    {% if announcements and current_user.is_authenticated %}
    <!-- å…¬å‘Šç›¸å…³CSSå’ŒJavaScript -->
    <style>
        /* ç¡®ä¿å·²è¯»å…¬å‘Šåœ¨é¡µé¢åŠ è½½æ—¶å®Œå…¨ä¸æ˜¾ç¤º */
        .announcement-item[data-read="true"] {
            display: none !important;
        }
        
        /* ä¸ºæœªè¯»å…¬å‘Šæ·»åŠ åˆå§‹éšè—çŠ¶æ€ï¼Œé¿å…é—ªçƒ */
        .announcement-item:not([data-read="true"]) {
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        /* å·²è¯»å…¬å‘Šçš„æ˜¾ç¤ºçŠ¶æ€ */
        .announcement-item[data-read="false"] {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    {% endif %}
    
    {% if announcements and current_user.is_authenticated %}
    <script>
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] å…¬å‘Šè°ƒè¯•: ${message}`, data || '');
        }
        
        // æ ‡è®°å…¬å‘Šä¸ºå·²è¯»
        function markAnnouncementAsRead(announcementId) {
            debugLog(`å¼€å§‹æ ‡è®°å…¬å‘Š ${announcementId} ä¸ºå·²è¯»`);
            
            // å°†å…¬å‘ŠIDå­˜å‚¨åˆ°localStorageï¼Œè¡¨ç¤ºç”¨æˆ·å·²è¯»
            const readAnnouncements = JSON.parse(localStorage.getItem('readAnnouncements') || '[]');
            debugLog(`å½“å‰å·²è¯»å…¬å‘Šåˆ—è¡¨:`, readAnnouncements);
            
            if (!readAnnouncements.includes(announcementId)) {
                readAnnouncements.push(announcementId);
                localStorage.setItem('readAnnouncements', JSON.stringify(readAnnouncements));
                debugLog(`å·²å°†å…¬å‘Š ${announcementId} æ·»åŠ åˆ°å·²è¯»åˆ—è¡¨`);
            } else {
                debugLog(`å…¬å‘Š ${announcementId} å·²åœ¨å·²è¯»åˆ—è¡¨ä¸­`);
            }
            
            // æ‰¾åˆ°å¯¹åº”çš„å…¬å‘Šå…ƒç´ å¹¶éšè—
            const announcementElement = document.querySelector(`[data-announcement-id="${announcementId}"]`);
            debugLog(`æŸ¥æ‰¾å…¬å‘Šå…ƒç´ :`, announcementElement);
            
            if (announcementElement) {
                debugLog(`å¼€å§‹éšè—å…¬å‘Šå…ƒç´  ${announcementId}`);
                // æ·»åŠ æ·¡å‡ºæ•ˆæœ
                announcementElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                announcementElement.style.opacity = '0';
                announcementElement.style.transform = 'translateY(-10px)';
                
                // å»¶è¿Ÿéšè—å…ƒç´ å¹¶æ ‡è®°ä¸ºå·²è¯»
                setTimeout(function() {
                    announcementElement.setAttribute('data-read', 'true');
                    debugLog(`å…¬å‘Šå…ƒç´  ${announcementId} å·²å®Œå…¨éšè—å¹¶æ ‡è®°ä¸ºå·²è¯»`);
                }, 300);
            } else {
                debugLog(`è­¦å‘Š: æœªæ‰¾åˆ°å…¬å‘Šå…ƒç´  ${announcementId}`);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶å¤„ç†å…¬å‘Šæ˜¾ç¤ºçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOMå†…å®¹åŠ è½½å®Œæˆï¼Œå¼€å§‹å¤„ç†å…¬å‘Š');
            
            const readAnnouncements = JSON.parse(localStorage.getItem('readAnnouncements') || '[]');
            debugLog('ä»localStorageè¯»å–å·²è¯»å…¬å‘Š:', readAnnouncements);
            
            const announcementItems = document.querySelectorAll('.announcement-item');
            debugLog(`æ‰¾åˆ° ${announcementItems.length} ä¸ªå…¬å‘Šå…ƒç´ `);
            
            announcementItems.forEach(function(item, index) {
                const announcementId = parseInt(item.getAttribute('data-announcement-id'));
                debugLog(`å¤„ç†å…¬å‘Š ${index + 1}: ID=${announcementId}, å…ƒç´ =`, item);
                
                if (readAnnouncements.includes(announcementId)) {
                    debugLog(`å…¬å‘Š ${announcementId} å·²è¯»ï¼Œæ ‡è®°ä¸ºå·²è¯»çŠ¶æ€`);
                    // ä½¿ç”¨CSSç±»æ§åˆ¶ï¼Œç¡®ä¿å®Œå…¨ä¸æ˜¾ç¤º
                    item.setAttribute('data-read', 'true');
                } else {
                    debugLog(`å…¬å‘Š ${announcementId} æœªè¯»ï¼Œæ ‡è®°ä¸ºæœªè¯»çŠ¶æ€`);
                    // æ ‡è®°ä¸ºæœªè¯»ï¼Œè§¦å‘CSSæ˜¾ç¤ºåŠ¨ç”»
                    item.setAttribute('data-read', 'false');
                    
                    // å»¶è¿Ÿæ˜¾ç¤ºï¼Œåˆ›å»ºæ·¡å…¥æ•ˆæœ
                    setTimeout(function() {
                        debugLog(`å¼€å§‹æ˜¾ç¤ºå…¬å‘Š ${announcementId} çš„æ·¡å…¥åŠ¨ç”»`);
                        // CSSä¼šè‡ªåŠ¨å¤„ç†åŠ¨ç”»æ•ˆæœ
                    }, 100);
                }
            });
            
            debugLog('å…¬å‘Šå¤„ç†å®Œæˆ');
        });
        
        // é¡µé¢å®Œå…¨åŠ è½½åçš„é¢å¤–æ£€æŸ¥
        window.addEventListener('load', function() {
            debugLog('é¡µé¢å®Œå…¨åŠ è½½å®Œæˆï¼Œè¿›è¡Œæœ€ç»ˆæ£€æŸ¥');
            
            const announcementItems = document.querySelectorAll('.announcement-item');
            announcementItems.forEach(function(item, index) {
                const announcementId = parseInt(item.getAttribute('data-announcement-id'));
                const isVisible = item.getAttribute('data-read') !== 'true' && item.offsetParent !== null;
                const dataRead = item.getAttribute('data-read');
                debugLog(`æœ€ç»ˆæ£€æŸ¥ - å…¬å‘Š ${announcementId}: å¯è§=${isVisible}, data-read=${dataRead}, opacity=${item.style.opacity}`);
            });
        });
        
        // æ·»åŠ æ¸…é™¤å·²è¯»è®°å½•çš„åŠŸèƒ½ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        function clearReadAnnouncements() {
            localStorage.removeItem('readAnnouncements');
            debugLog('å·²æ¸…é™¤æ‰€æœ‰å·²è¯»å…¬å‘Šè®°å½•ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæœ');
            // é‡æ–°å¤„ç†æ‰€æœ‰å…¬å‘Š
            const announcementItems = document.querySelectorAll('.announcement-item');
            announcementItems.forEach(function(item) {
                const announcementId = parseInt(item.getAttribute('data-announcement-id'));
                item.setAttribute('data-read', 'false');
                debugLog(`é‡æ–°æ ‡è®°å…¬å‘Š ${announcementId} ä¸ºæœªè¯»çŠ¶æ€`);
            });
        }
        
        // åœ¨æ§åˆ¶å°æš´éœ²æ¸…é™¤å‡½æ•°ï¼Œæ–¹ä¾¿è°ƒè¯•
        window.clearReadAnnouncements = clearReadAnnouncements;
    </script>
    {% endif %}
    
    {% block extra_js %}{% endblock %}
    
    <style>
    /* Markdownæ ·å¼ */
    .announcement-content h1,
    .announcement-content h2,
    .announcement-content h3,
    .announcement-content h4,
    .announcement-content h5,
    .announcement-content h6 {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .announcement-content h1 { font-size: 1.5rem; }
    .announcement-content h2 { font-size: 1.3rem; }
    .announcement-content h3 { font-size: 1.1rem; }

    .announcement-content p {
        margin-bottom: 1rem;
    }

    .announcement-content ul,
    .announcement-content ol {
        margin-bottom: 1rem;
        padding-left: 2rem;
    }

    .announcement-content blockquote {
        border-left: 4px solid #dee2e6;
        padding-left: 1rem;
        margin: 1rem 0;
        color: #6c757d;
        background-color: #f8f9fa;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
    }

    .announcement-content code {
        background-color: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
        color: #e83e8c;
    }

    .announcement-content pre {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        border: 1px solid #dee2e6;
    }

    .announcement-content pre code {
        background-color: transparent;
        padding: 0;
        color: inherit;
    }

    .announcement-content table {
        width: 100%;
        margin-bottom: 1rem;
        border-collapse: collapse;
    }

    .announcement-content table th,
    .announcement-content table td {
        padding: 0.5rem;
        border: 1px solid #dee2e6;
    }

    .announcement-content table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .announcement-content a {
        color: #0d6efd;
        text-decoration: none;
    }

    .announcement-content a:hover {
        text-decoration: underline;
    }
    </style>
</body>
</html>
