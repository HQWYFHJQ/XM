{% extends "base.html" %}

{% block title %}个性化推荐 - 校园跳蚤市场{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>
                    <i class="fas fa-magic me-2"></i>个性化推荐
                </h3>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="switchAlgorithm('hybrid')">
                        智能推荐
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="switchAlgorithm('collaborative')">
                        协同过滤
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="switchAlgorithm('content')">
                        内容推荐
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="switchAlgorithm('popularity')">
                        热门推荐
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 推荐说明 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>推荐说明：</strong>
                <span id="algorithmDescription">
                    基于你的浏览历史和兴趣偏好，为你推荐最合适的商品。推荐结果会随着你的使用而不断优化。
                </span>
            </div>
        </div>
    </div>
    
    <!-- 推荐商品 -->
    <div class="row" id="recommendationsContainer">
        {% if recommendations %}
            {% for item in recommendations %}
            <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                <div class="card h-100 shadow-sm recommendation-item" data-item-id="{{ item.id }}">
                    {% if item.main_image %}
                    <img src="{{ url_for('static', filename='uploads/items/' + item.main_image) }}" 
                         class="card-img-top" alt="{{ item.title }}" style="height: 200px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="fas fa-image fa-3x text-muted"></i>
                    </div>
                    {% endif %}
                    
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title">{{ item.title }}</h6>
                        <p class="card-text text-muted small flex-grow-1">{{ item.description[:50] }}...</p>
                        
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-primary fw-bold">¥{{ item.price }}</span>
                            <small class="text-muted">
                                <i class="fas fa-eye me-1"></i>{{ item.view_count }}
                            </small>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-tag me-1"></i>{{ item.category_name or '未分类' }}
                            </small>
                            <small class="text-muted">
                                {{ item.created_at | beijing_date }}
                            </small>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-transparent">
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('main.item_detail', item_id=item.id) }}" 
                               class="btn btn-primary btn-sm flex-grow-1" onclick="recordRecommendationClick({{ item.id }}, 'hybrid')">
                                查看详情
                            </a>
                            <button class="btn btn-outline-danger btn-sm like-btn" 
                                    data-item-id="{{ item.id }}" title="点赞">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-magic fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">暂无推荐商品</h5>
                <p class="text-muted">多浏览一些商品，系统会为你生成个性化推荐</p>
                <a href="{{ url_for('main.items') }}" class="btn btn-primary">
                    <i class="fas fa-shopping-bag me-2"></i>浏览商品
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- 加载更多 -->
    {% if recommendations and recommendations|length >= 20 %}
    <div class="row">
        <div class="col-12 text-center">
            <button class="btn btn-outline-primary load-more-btn" onclick="loadMoreRecommendations()">
                <i class="fas fa-plus me-2"></i>加载更多推荐
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- 推荐理由模态框 -->
<div class="modal fade" id="recommendationReasonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">推荐理由</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="recommendationReason">正在加载推荐理由...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAlgorithm = 'hybrid';
let currentPage = 1;

const algorithmDescriptions = {
    'hybrid': '基于你的浏览历史和兴趣偏好，为你推荐最合适的商品。推荐结果会随着你的使用而不断优化。',
    'collaborative': '基于相似用户的喜好，为你推荐他们喜欢的商品。',
    'content': '基于商品特征和你的兴趣偏好，推荐相似的商品。',
    'popularity': '推荐当前最热门的商品，发现校园里的热门好物。'
};

function switchAlgorithm(algorithm) {
    if (algorithm === currentAlgorithm) return;
    
    currentAlgorithm = algorithm;
    currentPage = 1;
    
    // 更新按钮状态
    $('.btn-group .btn').removeClass('active');
    $(`.btn-group .btn:contains('${getAlgorithmName(algorithm)}')`).addClass('active');
    
    // 更新描述
    $('#algorithmDescription').text(algorithmDescriptions[algorithm]);
    
    // 加载推荐
    loadRecommendations();
}

function getAlgorithmName(algorithm) {
    const names = {
        'hybrid': '智能推荐',
        'collaborative': '协同过滤',
        'content': '内容推荐',
        'popularity': '热门推荐'
    };
    return names[algorithm] || algorithm;
}

function loadRecommendations() {
    const container = $('#recommendationsContainer');
    container.html(`
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-3 text-muted">正在生成推荐...</p>
        </div>
    `);
    
    $.ajax({
        url: '/api/recommendations',
        method: 'GET',
        data: {
            algorithm: currentAlgorithm,
            limit: 20
        },
        success: function(response) {
            if (response.success && response.data.length > 0) {
                renderRecommendations(response.data);
            } else {
                container.html(`
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-magic fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">暂无推荐商品</h5>
                            <p class="text-muted">多浏览一些商品，系统会为你生成个性化推荐</p>
                            <a href="{{ url_for('main.items') }}" class="btn btn-primary">
                                <i class="fas fa-shopping-bag me-2"></i>浏览商品
                            </a>
                        </div>
                    </div>
                `);
            }
        },
        error: function() {
            container.html(`
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-muted">加载失败</h5>
                        <p class="text-muted">请稍后重试</p>
                        <button class="btn btn-primary" onclick="loadRecommendations()">
                            <i class="fas fa-redo me-2"></i>重新加载
                        </button>
                    </div>
                </div>
            `);
        }
    });
}

function renderRecommendations(items) {
    let html = '';
    items.forEach(function(item) {
        // 处理图片显示
        let imageHtml = '';
        if (item.images && item.images.length > 0) {
            imageHtml = `<img src="/static/uploads/items/${item.images[0]}" class="card-img-top" alt="${item.title}" style="height: 200px; object-fit: cover;">`;
        } else {
            imageHtml = `<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;"><i class="fas fa-image fa-3x text-muted"></i></div>`;
        }
        
        // 格式化日期
        const createdDate = new Date(item.created_at).toLocaleDateString('zh-CN');
        
        html += `
            <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                <div class="card h-100 shadow-sm recommendation-item" data-item-id="${item.id}">
                    ${imageHtml}
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title">${item.title}</h6>
                        <p class="card-text text-muted small flex-grow-1">${item.description ? item.description.substring(0, 50) + '...' : '暂无描述'}</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-primary fw-bold">¥${item.price}</span>
                            <small class="text-muted"><i class="fas fa-eye me-1"></i>${item.view_count || 0}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted"><i class="fas fa-tag me-1"></i>${item.category_name || '未分类'}</small>
                            <small class="text-muted">${createdDate}</small>
                        </div>
                        ${item.reason ? `<div class="mt-2"><small class="text-info"><i class="fas fa-info-circle me-1"></i>${item.reason}</small></div>` : ''}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex gap-2">
                            <a href="/item/${item.id}" class="btn btn-primary btn-sm flex-grow-1" onclick="recordRecommendationClick(${item.id}, '${currentAlgorithm}')">
                                查看详情
                            </a>
                            <button class="btn btn-outline-danger btn-sm like-btn" data-item-id="${item.id}" title="点赞">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    $('#recommendationsContainer').html(html);
}

function loadMoreRecommendations() {
    currentPage++;
    
    $.ajax({
        url: '/api/recommendations',
        method: 'GET',
        data: {
            algorithm: currentAlgorithm,
            limit: 20,
            page: currentPage
        },
        success: function(response) {
            if (response.success && response.data.length > 0) {
                const container = $('#recommendationsContainer');
                const newItems = response.data.map(function(item) {
                    return `
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                            <div class="card h-100 shadow-sm recommendation-item" data-item-id="${item.id}">
                                ${item.main_image ? 
                                    `<img src="/static/uploads/items/${item.main_image}" class="card-img-top" alt="${item.title}" style="height: 200px; object-fit: cover;">` :
                                    `<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;"><i class="fas fa-image fa-3x text-muted"></i></div>`
                                }
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title">${item.title}</h6>
                                    <p class="card-text text-muted small flex-grow-1">${item.description.substring(0, 50)}...</p>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-primary fw-bold">¥${item.price}</span>
                                        <small class="text-muted"><i class="fas fa-eye me-1"></i>${item.view_count}</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted"><i class="fas fa-tag me-1"></i>${item.category_name || '未分类'}</small>
                                        <small class="text-muted">${utils.formatBeijingTime(item.created_at, 'YYYY-MM-DD')}</small>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="d-flex gap-2">
                                        <a href="/item/${item.id}" class="btn btn-primary btn-sm flex-grow-1" onclick="recordRecommendationClick(${item.id}, '${currentAlgorithm}')">
                                            查看详情
                                        </a>
                                        <button class="btn btn-outline-danger btn-sm like-btn" data-item-id="${item.id}" title="点赞">
                                            <i class="far fa-heart"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.append(newItems);
            } else {
                $('.load-more-btn').hide();
            }
        },
        error: function() {
            currentPage--;
            showAlert('加载失败，请重试', 'error');
        }
    });
}

function recordRecommendationClick(itemId, algorithm) {
    $.ajax({
        url: `/api/recommendations/${itemId}/click`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ algorithm: algorithm }),
        success: function(response) {
            // 推荐点击记录成功
        },
        error: function() {
            // 忽略错误，不影响用户体验
        }
    });
}

$(document).ready(function() {
    // 初始化推荐页面
    if ($('#recommendationsContainer .recommendation-item').length === 0) {
        loadRecommendations();
    }
});
</script>
{% endblock %}
