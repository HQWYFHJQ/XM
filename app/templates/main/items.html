{% extends "base.html" %}

{% block title %}商品列表 - 校园跳蚤市场{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-lg-5 my-4">
    <div class="row">
        <!-- 侧边栏筛选 -->
        <aside class="col-xl-2 col-lg-3 col-md-4" role="complementary" aria-label="商品筛选">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">筛选条件</h5>
                </div>
                <div class="card-body">
                    <form method="GET" id="filterForm" role="search" aria-label="商品筛选表单">
                        <!-- 分类筛选 -->
                        <div class="mb-3">
                            <label for="filter_parent_category" class="form-label">一级分类</label>
                            <select name="parent_category" class="form-select" id="filter_parent_category" 
                                    aria-describedby="parent_category_help">
                                <option value="">全部分类</option>
                                {% for category in parent_categories %}
                                <option value="{{ category.id }}" {% if current_parent_category == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div id="parent_category_help" class="form-text">选择商品的一级分类</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="filter_category" class="form-label">子分类</label>
                            <select name="category" class="form-select" id="filter_category" 
                                    aria-describedby="category_help">
                                <option value="">全部分类</option>
                                {% for category in child_categories %}
                                <option value="{{ category.id }}" {% if current_category == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div id="category_help" class="form-text">选择商品的子分类</div>
                        </div>
                        
                        <!-- 排序方式 -->
                        <div class="mb-3">
                            <label for="sort_select" class="form-label">排序方式</label>
                            <select name="sort" class="form-select" id="sort_select" 
                                    aria-describedby="sort_help">
                                <option value="latest" {% if current_sort == 'latest' %}selected{% endif %}>最新发布</option>
                                <option value="price_asc" {% if current_sort == 'price_asc' %}selected{% endif %}>价格从低到高</option>
                                <option value="price_desc" {% if current_sort == 'price_desc' %}selected{% endif %}>价格从高到低</option>
                                <option value="popular" {% if current_sort == 'popular' %}selected{% endif %}>最受欢迎</option>
                            </select>
                            <div id="sort_help" class="form-text">选择商品的排序方式</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100" aria-label="应用筛选条件">应用筛选</button>
                    </form>
                </div>
            </div>
        </aside>
        
        <!-- 商品列表 -->
        <main class="col-xl-10 col-lg-9 col-md-8" role="main" aria-label="商品列表">
            <!-- 搜索结果信息 -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="h4">
                    {% if current_search %}
                        <span class="visually-hidden">搜索结果：</span>"{{ current_search }}"
                    {% elif current_category %}
                        {% for category in categories %}
                            {% if category.id == current_category %}
                                <span class="visually-hidden">分类：</span>{{ category.name }}
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        所有商品
                    {% endif %}
                </h1>
                <span class="text-muted" aria-label="商品总数：{{ items.total }}个">
                    <span class="visually-hidden">共</span>{{ items.total }}<span class="visually-hidden">个商品</span>
                </span>
            </div>
            
            <!-- 商品网格 -->
            {% if items.items %}
            <div class="row" role="list" aria-label="商品列表">
                {% for item in items.items %}
                <div class="col-xxl-3 col-xl-4 col-lg-6 col-md-6 mb-4" role="listitem">
                    <article class="card h-100 shadow-sm item-card">
                        {% if item.get_main_image() %}
                        <img src="{{ url_for('static', filename='uploads/items/' + item.get_main_image()) }}" 
                             class="card-img-top" alt="{{ item.title }}的商品图片" style="height: 200px; object-fit: cover;">
                        {% else %}
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;" 
                             aria-label="暂无商品图片">
                            <i class="fas fa-image fa-3x text-muted" aria-hidden="true"></i>
                        </div>
                        {% endif %}
                        
                        <div class="card-body d-flex flex-column">
                            <h2 class="card-title h6">{{ item.title }}</h2>
                            <p class="card-text text-muted small flex-grow-1">{{ item.description[:80] }}...</p>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-primary fw-bold item-price" aria-label="价格：{{ item.price }}元">¥{{ item.price }}</span>
                                <small class="text-muted item-stats">
                                    <i class="fas fa-eye me-1" aria-hidden="true"></i>
                                    <span class="visually-hidden">浏览次数：</span>{{ item.view_count }}
                                </small>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-tag me-1" aria-hidden="true"></i>
                                    <span class="visually-hidden">分类：</span>{{ item.category_name or '未分类' }}
                                </small>
                                <small class="text-muted">
                                    <span class="visually-hidden">发布时间：</span>{{ item.created_at | beijing_date }}
                                </small>
                            </div>
                        </div>
                        
                        <div class="card-footer bg-transparent">
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('main.item_detail', item_id=item.id) }}" 
                                   class="btn btn-primary btn-sm flex-grow-1" 
                                   aria-label="查看{{ item.title }}的详细信息">
                                    查看详情
                                </a>
                                {% if current_user.is_authenticated %}
                                <button class="btn btn-outline-danger btn-sm like-btn" 
                                        data-item-id="{{ item.id }}" 
                                        aria-label="为{{ item.title }}点赞" 
                                        title="点赞">
                                    <i class="far fa-heart" aria-hidden="true"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                </div>
                {% endfor %}
            </div>
            
            <!-- 分页 -->
            {% if items.pages > 1 %}
            <nav aria-label="商品分页导航">
                <ul class="pagination justify-content-center" role="list">
                    {% if items.has_prev %}
                    <li class="page-item" role="listitem">
                        <a class="page-link" href="{{ url_for('main.items', page=items.prev_num, category=current_category, search=current_search, sort=current_sort) }}" 
                           aria-label="上一页，第{{ items.prev_num }}页">
                            上一页
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in items.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != items.page %}
                            <li class="page-item" role="listitem">
                                <a class="page-link" href="{{ url_for('main.items', page=page_num, category=current_category, search=current_search, sort=current_sort) }}" 
                                   aria-label="第{{ page_num }}页">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item active" role="listitem">
                                <span class="page-link" aria-current="page" aria-label="当前页，第{{ page_num }}页">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled" role="listitem">
                            <span class="page-link" aria-hidden="true">...</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if items.has_next %}
                    <li class="page-item" role="listitem">
                        <a class="page-link" href="{{ url_for('main.items', page=items.next_num, category=current_category, search=current_search, sort=current_sort) }}" 
                           aria-label="下一页，第{{ items.next_num }}页">
                            下一页
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            
            {% else %}
            <!-- 无商品时的提示 -->
            <div class="text-center py-5" role="status" aria-live="polite">
                <i class="fas fa-search fa-3x text-muted mb-3" aria-hidden="true"></i>
                <h5 class="text-muted">暂无商品</h5>
                <p class="text-muted">试试调整筛选条件或发布新商品</p>
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.create_item') }}" class="btn btn-primary" 
                   aria-label="发布新商品">
                    <i class="fas fa-plus me-2" aria-hidden="true"></i>发布商品
                </a>
                {% endif %}
            </div>
            {% endif %}
        </main>
    </div>
</div>
{% endblock %}

<script>
// 多级分类筛选功能
document.addEventListener('DOMContentLoaded', function() {
    const parentSelect = document.getElementById('filter_parent_category');
    const childSelect = document.getElementById('filter_category');
    
    // 分类数据
    const categoriesData = {{ categories_data | tojson }};
    
    parentSelect.addEventListener('change', function() {
        const parentId = this.value;
        childSelect.innerHTML = '<option value="">全部分类</option>';
        
        if (parentId) {
            const parentCategory = categoriesData.find(cat => cat.id == parentId);
            if (parentCategory && parentCategory.children) {
                parentCategory.children.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child.id;
                    option.textContent = child.name;
                    childSelect.appendChild(option);
                });
            }
        }
    });
    
    // 自动提交表单
    parentSelect.addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
    
    childSelect.addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
});
</script>

{% block extra_js %}
<script>
$(document).ready(function() {
    // 筛选表单自动提交
    $('#filterForm select').on('change', function() {
        $('#filterForm').submit();
    });
});
</script>
{% endblock %}
